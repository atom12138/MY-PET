(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/medical/list"],{"15fc":function(t,e,o){"use strict";o.r(e);var n=o("a654"),i=o("e136");for(var s in i)["default"].indexOf(s)<0&&function(t){o.d(e,t,(function(){return i[t]}))}(s);o("a4ca");var r=o("828b"),a=Object(r["a"])(i["default"],n["b"],n["c"],!1,null,"2b8cf69e",null,!1,n["a"],void 0);e["default"]=a.exports},"1c52":function(t,e,o){"use strict";(function(t){var n=o("47a9");Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i=n(o("7eb4")),s=n(o("7ca3")),r=n(o("ee10"));function a(t,e){var o=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),o.push.apply(o,n)}return o}var c={data:function(){return{searchKeyword:"",selectedDepartment:"all",currentDoctor:{},inputMessage:"",chatMessages:[],baseUrl:"",scrollTop:0,appointmentDate:"",timeIndex:0,symptomDescription:"",departmentList:[{id:"all",name:"å…¨éƒ¨ç§‘å®¤",icon:"ğŸ¥"},{id:"internal",name:"å†…ç§‘",icon:"ğŸ«€"},{id:"surgery",name:"å¤–ç§‘",icon:"ğŸ”ª"},{id:"dermatology",name:"çš®è‚¤ç§‘",icon:"ğŸ¦ "},{id:"ophthalmology",name:"çœ¼ç§‘",icon:"ğŸ‘ï¸"},{id:"dental",name:"å£è…”ç§‘",icon:"ğŸ¦·"},{id:"emergency",name:"æ€¥è¯Šç§‘",icon:"ğŸš‘"},{id:"vaccine",name:"ç–«è‹—ç§‘",icon:"ğŸ’‰"}],doctorList:[],timeSlots:["09:00","09:30","10:00","10:30","11:00","14:00","14:30","15:00","15:30","16:00"],isDoctor:!1,doctorInfo:{},patientMessages:[],currentPatient:{},doctorPollingTimer:null,userPollingTimer:null,chatPollingTimer:null,isChatOpen:!1,doctorListPollingTimer:null,doctorReady:!1}},onLoad:function(){this.baseUrl=this.$api.baseUrl,console.log("å½“å‰ baseUrl:",this.baseUrl);try{var e=t.getStorageSync("nowTable");if("doctor"===e){this.isDoctor=!0;try{t.hideTabBar()}catch(o){}}}catch(o){}this.checkUserType(),this.loadDoctorList()},onShow:function(){if(this.isDoctor)try{t.hideTabBar()}catch(e){}else try{t.showTabBar()}catch(e){}this.isDoctor&&this.doctorInfo&&this.doctorInfo.id?(this.checkNewMessages(),this.doctorPollingTimer||this.startDoctorPolling()):this.doctorListPollingTimer||this.startDoctorListPolling()},onHide:function(){this.stopDoctorPolling(),this.stopUserPolling(),this.stopDoctorChatPolling(),this.stopDoctorListPolling()},onUnload:function(){this.stopDoctorPolling(),this.stopUserPolling()},computed:{filteredDoctorList:function(){var t=this,e=this.doctorList;return"all"!==this.selectedDepartment&&(e=e.filter((function(e){return e.departmentId===t.selectedDepartment}))),this.searchKeyword&&(e=e.filter((function(e){return e.name.includes(t.searchKeyword)||e.department.includes(t.searchKeyword)}))),e}},methods:{switchTo:function(e){"medical"!==e&&"center"===e&&t.switchTab({url:"/pages/center/center"})},onClearChatTap:function(){var e=this;return(0,r.default)(i.default.mark((function o(){return i.default.wrap((function(o){while(1)switch(o.prev=o.next){case 0:if(e.isChatOpen){o.next=2;break}return o.abrupt("return");case 2:t.showModal({title:"æ¸…ç©ºèŠå¤©è®°å½•",content:"ç¡®å®šè¦æ¸…ç©ºå½“å‰ä¼šè¯çš„æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚",success:function(){var t=(0,r.default)(i.default.mark((function t(o){return i.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(!o.confirm){t.next=3;break}return t.next=3,e.clearChatHistory();case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()});case 3:case"end":return o.stop()}}),o)})))()},clearChatHistory:function(){var e=this;return(0,r.default)(i.default.mark((function o(){var n,s;return i.default.wrap((function(o){while(1)switch(o.prev=o.next){case 0:if(o.prev=0,!e.isDoctor){o.next=9;break}if(e.doctorInfo&&e.doctorInfo.id&&e.currentPatient&&e.currentPatient.userId){o.next=5;break}return t.showToast({title:"åŒ»ç”Ÿæˆ–æ‚£è€…ä¿¡æ¯ä¸å®Œæ•´",icon:"none"}),o.abrupt("return");case 5:s=e.doctorInfo.id,n=e.currentPatient.userId,o.next=14;break;case 9:if(n=t.getStorageSync("userid"),s=e.currentDoctor&&e.currentDoctor.id,n&&s){o.next=14;break}return t.showToast({title:"ç”¨æˆ·æˆ–åŒ»ç”Ÿä¿¡æ¯ä¸å®Œæ•´",icon:"none"}),o.abrupt("return");case 14:return e.stopUserPolling(),e.stopDoctorChatPolling(),t.showLoading({title:"æ¸…ç†ä¸­..."}),o.next=19,e.$api.post("message/clearConversation?userId=".concat(n,"&doctorId=").concat(s),{});case 19:t.hideLoading(),e.chatMessages=[],e.scrollToBottom(),t.showToast({title:"å·²æ¸…ç©º",icon:"success"}),e.isChatOpen&&(e.isDoctor?e.startDoctorChatPolling():e.startUserPolling()),o.next=31;break;case 26:o.prev=26,o.t0=o["catch"](0),t.hideLoading(),console.error("æ¸…ç©ºèŠå¤©è®°å½•å¤±è´¥",o.t0),t.showToast({title:"æ¸…ç©ºå¤±è´¥ï¼Œè¯·ç¨åå†è¯•",icon:"none"});case 31:case"end":return o.stop()}}),o,null,[[0,26]])})))()},normalizeImage:function(t){if(!t)return"";if(/^https?:\/\//i.test(t))return t;var e=String(t).replace(/^\/+/,"");return e.startsWith("upload/")?"".concat(this.baseUrl,"/").concat(e):"".concat(this.baseUrl,"/upload/").concat(e)},chooseImage:function(){var e=this;t.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:function(o){var n=o.tempFilePaths[0],i=e.baseUrl+"/file/upload";t.showLoading({title:"ä¸Šä¼ ä¸­..."}),t.uploadFile({url:i,filePath:n,name:"file",header:{Token:t.getStorageSync("token")},success:function(o){t.hideLoading();var n=JSON.parse(o.data);0===n.code?e.sendAsMessage({imageUrl:n.file}):t.showToast({title:n.msg||"ä¸Šä¼ å¤±è´¥",icon:"none"})},fail:function(e){t.hideLoading(),t.showToast({title:"ä¸Šä¼ å¤±è´¥",icon:"none"})}})}})},previewImage:function(e){t.previewImage({urls:[e]})},onSearchInput:function(){},checkUserType:function(){var e=this,o=t.getStorageSync("nowTable")||"defaultuser",n=t.getStorageSync("userid");n?this.$api.session(o).then((function(n){if(console.log("ç”¨æˆ·ä¿¡æ¯å“åº”:",n),n&&n.data){var i=n.data,s="doctor"===o;if(e.isDoctor=s,e.isDoctor){try{t.hideTabBar()}catch(c){}e.doctorInfo=i,e.doctorReady=!0,t.setStorageSync("doctorInfo",i);try{var r=t.getStorageSync("lastDoctorId");r&&r!==e.doctorInfo.id&&e.$api.post("doctor/updateOnlineStatus?id=".concat(r,"&online=0"),{})}catch(c){}t.setStorageSync("lastDoctorId",e.doctorInfo.id),console.log("åŒ»ç”Ÿä¿¡æ¯å·²è®¾ç½®å¹¶å­˜å‚¨:",e.doctorInfo),e.checkNewMessages(),e.startDoctorPolling()}else{try{t.showTabBar()}catch(c){}console.log("éåŒ»ç”Ÿç”¨æˆ·:",i),t.removeStorageSync("doctorInfo"),e.doctorReady=!1;try{var a=t.getStorageSync("lastDoctorId");a&&(e.$api.post("doctor/updateOnlineStatus?id=".concat(a,"&online=0"),{}),t.removeStorageSync("lastDoctorId"))}catch(c){}}}else e.isDoctor=!1,e.doctorInfo={},e.doctorReady=!1,console.error("æœªè·å–åˆ°ç”¨æˆ·ä¿¡æ¯"),t.removeStorageSync("doctorInfo")})).catch((function(o){console.error("è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥",o),e.isDoctor=!1,e.doctorInfo={},e.doctorReady=!1,t.removeStorageSync("doctorInfo")})):(this.isDoctor=!1,this.doctorInfo={},this.doctorReady=!1,console.error("ç”¨æˆ·æœªç™»å½•"),t.removeStorageSync("doctorInfo"))},loadDoctorList:function(){var e=this,o=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];o&&t.showLoading({title:"åŠ è½½ä¸­..."}),this.$api.page("doctor",{}).then((function(n){o&&t.hideLoading(),n&&0===n.code&&n.data&&n.data.list?e.doctorList=n.data.list.map((function(t){return{id:t.id,name:t.doctorxingming,title:t.zhicheng,department:t.keshi,avatar:t.touxiang||"",avatarUrl:e.normalizeImage(t.touxiang),account:t.doctorzhanghao||"",rating:t.pingfen||5,departmentId:e.getDepartmentId(t.keshi),specialty:"æ“…é•¿ï¼š".concat(t.zhuanchang||"å® ç‰©ç–¾ç—…è¯Šç–—"),online:1===Number(t.online)?1:0}})):t.showToast({title:n.msg||"åŠ è½½åŒ»ç”Ÿåˆ—è¡¨å¤±è´¥",icon:"none"})})).catch((function(e){o&&t.hideLoading(),console.error("åŠ è½½åŒ»ç”Ÿåˆ—è¡¨å¤±è´¥",e);var n="åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åå†è¯•";e&&e.errMsg?n+=" (".concat(e.errMsg,")"):e&&e.message&&(n+=" (".concat(e.message,")")),t.showToast({title:n,icon:"none"})}))},startDoctorListPolling:function(){var t=this;this.doctorListPollingTimer||(this.doctorListPollingTimer=setInterval((function(){t.isDoctor||t.loadDoctorList(!1)}),2e4))},stopDoctorListPolling:function(){this.doctorListPollingTimer&&(clearInterval(this.doctorListPollingTimer),this.doctorListPollingTimer=null)},getDepartmentId:function(t){return{"å†…ç§‘":"internal","å¤–ç§‘":"surgery","çš®è‚¤ç§‘":"dermatology","çœ¼ç§‘":"ophthalmology","å£è…”ç§‘":"dental","æ€¥è¯Šç§‘":"emergency","ç–«è‹—ç§‘":"vaccine"}[t]||"all"},checkNewMessages:function(){var e=this,o=t.getStorageSync("doctorInfo");if(o&&!this.doctorInfo.id&&(this.doctorInfo=o,this.isDoctor=!0,console.log("ä»æœ¬åœ°å­˜å‚¨æ¢å¤åŒ»ç”Ÿä¿¡æ¯:",this.doctorInfo)),!this.isDoctor||!this.doctorInfo.id)return console.error("ä¸æ˜¯åŒ»ç”Ÿæˆ–åŒ»ç”Ÿä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•åŠ è½½æ‚£è€…æ¶ˆæ¯"),void(this.doctorReady&&t.showToast({title:"åŒ»ç”Ÿèº«ä»½éªŒè¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•",icon:"none"}));this.$api.list("message",{type:"unread",doctorId:this.doctorInfo.id}).then((function(o){if(console.log("æ¶ˆæ¯åˆ—è¡¨å“åº”:",o),o&&0===o.code&&o.data){var n=o.data.filter((function(t){return"user"===t.senderType})).map((function(t){return{id:t.id,patientName:t.userName||"æœªçŸ¥æ‚£è€…",content:t.content||"",time:e.formatTime(new Date(t.sendTime||Date.now())),userId:t.userId,senderType:t.senderType,sendTime:t.sendTime||Date.now()}})),i=new Map;n.forEach((function(t){(!i.has(t.userId)||new Date(t.sendTime)>new Date(i.get(t.userId).sendTime))&&i.set(t.userId,t)}));var r=Array.from(i.values()),c=new Map(e.patientMessages.map((function(t,e){return[t.userId,{idx:e,item:t}]}))),d=!1;r.forEach((function(t){var o=c.get(t.userId);if(o){var n=o.item;n.id===t.id&&n.content===t.content&&n.sendTime===t.sendTime||(n.id=t.id,n.patientName=t.patientName,n.content=t.content,n.time=t.time,n.senderType=t.senderType,n.sendTime=t.sendTime,d=!0)}else e.patientMessages.push(function(t){for(var e=1;e<arguments.length;e++){var o=null!=arguments[e]?arguments[e]:{};e%2?a(Object(o),!0).forEach((function(e){(0,s.default)(t,e,o[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):a(Object(o)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))}))}return t}({},t)),d=!0}));var l=new Set(r.map((function(t){return t.userId}))),u=e.patientMessages.length;e.patientMessages=e.patientMessages.filter((function(t){return l.has(t.userId)})),e.patientMessages.length!==u&&(d=!0),d&&(e.patientMessages.sort((function(t,e){return new Date(e.sendTime)-new Date(t.sendTime)})),console.log("åŠ è½½æ‚£è€…æ¶ˆæ¯æˆåŠŸï¼Œå…±",e.patientMessages.length,"æ¡(å·²å»é‡/å¢é‡æ›´æ–°)"),t.vibrateShort())}else console.error("åŠ è½½æ¶ˆæ¯å¤±è´¥:",o),t.showToast({title:o.msg||"åŠ è½½æ¶ˆæ¯å¤±è´¥",icon:"none"})})).catch((function(e){console.error("åŠ è½½æ¶ˆæ¯å¤±è´¥",e),t.showToast({title:"ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•",icon:"none"})}))},selectDepartment:function(t){this.selectedDepartment=t},onDoctorTap:function(e){t.showToast({title:"æŸ¥çœ‹".concat(e.name,"å…½åŒ»è¯¦æƒ…"),icon:"none"})},replyToPatient:function(e){var o=this;this.stopDoctorChatPolling(),this.currentPatient=e,t.showLoading({title:"åŠ è½½èŠå¤©è®°å½•ä¸­..."}),this.$api.list("message",{doctorId:this.doctorInfo.id,userId:e.userId}).then((function(e){t.hideLoading(),e&&0===e.code&&e.data?(o.chatMessages=e.data.map((function(t){return{id:t.id,content:t.content,imageUrl:t.imageUrl,time:o.formatTime(new Date(t.sendTime)),ts:t.sendTime?new Date(t.sendTime).getTime():t.id||0,senderType:"doctor"===t.senderType?"doctor":"user"}})),o.chatMessages.sort((function(t,e){return(t.ts||0)-(e.ts||0)})),o.currentDoctor={id:o.doctorInfo.id,name:o.doctorInfo.doctorxingming},o.$refs.chatPopup.open(),o.isChatOpen=!0,o.$nextTick((function(){setTimeout((function(){o.scrollToBottom()}),500)})),o.startDoctorChatPolling()):t.showToast({title:e.msg||"åŠ è½½èŠå¤©è®°å½•å¤±è´¥",icon:"none"})})).catch((function(e){t.hideLoading(),console.error("åŠ è½½èŠå¤©è®°å½•å¤±è´¥",e),t.showToast({title:"åŠ è½½èŠå¤©è®°å½•å¤±è´¥ï¼Œè¯·ç¨åå†è¯•",icon:"none"})}))},startChat:function(e){var o=this;if(this.currentDoctor=e,this.chatMessages=[],this.isDoctor)this.chatMessages=[{id:Date.now(),content:"æ‚¨å¥½ï¼Œæˆ‘æ˜¯".concat(e.name,"å…½åŒ»ï¼Œè¯·é—®æ‚¨çš„å® ç‰©æœ‰ä»€ä¹ˆé—®é¢˜éœ€è¦å¸®åŠ©å—ï¼Ÿ"),time:this.formatTime(new Date),ts:Date.now(),senderType:"doctor"}],this.$refs.chatPopup.open(),this.$nextTick((function(){setTimeout((function(){o.scrollToBottom()}),500)}));else{t.showLoading({title:"åŠ è½½èŠå¤©è®°å½•ä¸­..."});var n=t.getStorageSync("userid");this.$api.list("message",{userId:n,doctorId:e.id}).then((function(n){t.hideLoading(),n&&0===n.code&&n.data?(o.chatMessages=n.data.map((function(t){return{id:t.id,content:t.content,imageUrl:t.imageUrl,time:o.formatTime(new Date(t.sendTime)),ts:t.sendTime?new Date(t.sendTime).getTime():t.id||0,senderType:"doctor"===t.senderType?"doctor":"user"}})),o.chatMessages.sort((function(t,e){return(t.ts||0)-(e.ts||0)})),0===o.chatMessages.length&&o.chatMessages.push({id:Date.now()+Math.floor(1e3*Math.random()),content:"æ‚¨å¥½ï¼Œæˆ‘æ˜¯".concat(e.name,"å…½åŒ»ï¼Œè¯·é—®æ‚¨çš„å® ç‰©æœ‰ä»€ä¹ˆé—®é¢˜éœ€è¦å¸®åŠ©å—ï¼Ÿ"),time:o.formatTime(new Date),ts:Date.now(),senderType:"doctor"})):(o.chatMessages.push({id:Date.now()+Math.floor(1e3*Math.random()),content:"æ‚¨å¥½ï¼Œæˆ‘æ˜¯".concat(e.name,"å…½åŒ»ï¼Œè¯·é—®æ‚¨çš„å® ç‰©æœ‰ä»€ä¹ˆé—®é¢˜éœ€è¦å¸®åŠ©å—ï¼Ÿ"),time:o.formatTime(new Date),ts:Date.now(),senderType:"doctor"}),t.showToast({title:n.msg||"åŠ è½½èŠå¤©è®°å½•å¤±è´¥",icon:"none"})),o.$refs.chatPopup.open(),o.isChatOpen=!0,o.startUserPolling(),o.$nextTick((function(){setTimeout((function(){o.scrollToBottom()}),500)}))})).catch((function(n){t.hideLoading(),console.error("åŠ è½½èŠå¤©è®°å½•å¤±è´¥",n),o.chatMessages.push({id:Date.now()+Math.floor(1e3*Math.random()),content:"æ‚¨å¥½ï¼Œæˆ‘æ˜¯".concat(e.name,"å…½åŒ»ï¼Œè¯·é—®æ‚¨çš„å® ç‰©æœ‰ä»€ä¹ˆé—®é¢˜éœ€è¦å¸®åŠ©å—ï¼Ÿ"),time:o.formatTime(new Date),ts:Date.now(),senderType:"doctor"}),t.showToast({title:"åŠ è½½èŠå¤©è®°å½•å¤±è´¥ï¼Œè¯·ç¨åå†è¯•",icon:"none"}),o.$refs.chatPopup.open(),o.isChatOpen=!0,o.startUserPolling(),o.$nextTick((function(){setTimeout((function(){o.scrollToBottom()}),500)}))}))}},closeChat:function(){this.$refs.chatPopup.close(),this.inputMessage="",this.isChatOpen=!1,this.stopUserPolling(),this.stopDoctorChatPolling()},sendMessage:function(){this.inputMessage.trim()?this.sendAsMessage({content:this.inputMessage}):t.showToast({title:"è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹",icon:"none"})},sendAsMessage:function(e){var o=this,n=e.content,i=e.imageUrl;if(n||i){var s={id:Date.now()+Math.floor(1e3*Math.random()),content:n,imageUrl:i,time:this.formatTime(new Date),ts:Date.now(),senderType:this.isDoctor?"doctor":"user"};this.chatMessages.push(s),this.chatMessages.sort((function(t,e){return(t.ts||0)-(e.ts||0)})),this.scrollToBottom(),this.inputMessage="",this.isDoctor?this.executeSendMessage(n,i):this.$api.info("doctor",this.currentDoctor.id).then((function(e){0===e.code&&e.data&&1!==Number(e.data.online)?t.showModal({title:"æç¤º",content:"å½“å‰åŒ»ç”Ÿä¸åœ¨çº¿ï¼Œæ‚¨çš„æ¶ˆæ¯å°†è½¬ä¸ºç•™è¨€ï¼ŒåŒ»ç”Ÿä¸Šçº¿åä¼šå°½å¿«å›å¤æ‚¨ã€‚",showCancel:!1,success:function(){o.executeSendMessage(n,i)}}):o.executeSendMessage(n,i)})).catch((function(t){console.error("æ£€æŸ¥åŒ»ç”ŸçŠ¶æ€å¤±è´¥",t),o.executeSendMessage(n,i)}))}},executeSendMessage:function(e,o){var n,i=this;if(t.showLoading({title:"å‘é€ä¸­..."}),this.isDoctor){if(!this.doctorInfo||!this.doctorInfo.id||!this.currentPatient||!this.currentPatient.userId)return t.hideLoading(),void t.showToast({title:"åŒ»ç”Ÿæˆ–æ‚£è€…ä¿¡æ¯ä¸å®Œæ•´",icon:"none"});var s="userId=".concat(this.currentPatient.userId,"&username=").concat(this.currentPatient.patientName,"&doctorId=").concat(this.doctorInfo.id);e&&(s+="&content=".concat(encodeURIComponent(e))),o&&(s+="&imageUrl=".concat(encodeURIComponent(o))),n=this.$api.post("message/reply?".concat(s),{role:"doctor",doctorId:this.doctorInfo.id})}else{var r="doctorId=".concat(this.currentDoctor.id);e&&(r+="&content=".concat(encodeURIComponent(e))),o&&(r+="&imageUrl=".concat(encodeURIComponent(o))),n=this.$api.post("message/send?".concat(r),{})}n.then((function(e){t.hideLoading(),0===e.code?i.isDoctor||i.startUserPolling():t.showToast({title:e.msg||"å‘é€å¤±è´¥",icon:"none"})})).catch((function(e){t.hideLoading(),console.error("å‘é€æ¶ˆæ¯å¤±è´¥",e),t.showToast({title:"å‘é€å¤±è´¥ï¼Œè¯·ç¨åå†è¯•",icon:"none"})}))},checkDoctorReply:function(){var e=this;this.currentDoctor&&this.currentDoctor.id&&this.$api.list("message",{userId:t.getStorageSync("userid"),doctorId:this.currentDoctor.id}).then((function(o){var n=o&&o.data||[];if(Array.isArray(n)&&n.length>0){var i=new Set(e.chatMessages.map((function(t){return t.id}))),s=!1;n.forEach((function(t){"doctor"!==t.senderType||i.has(t.id)||(e.chatMessages.push({id:t.id,content:t.content,imageUrl:t.imageUrl,time:e.formatTime(new Date(t.sendTime)),ts:t.sendTime?new Date(t.sendTime).getTime():t.id||0,senderType:"doctor"}),s=!0)})),s&&(e.chatMessages.sort((function(t,e){return(t.ts||0)-(e.ts||0)})),e.scrollToBottom(),t.vibrateShort())}})).catch((function(t){console.error("è·å–åŒ»ç”Ÿå›å¤å¤±è´¥",t)}))},startUserPolling:function(){var t=this;this.userPollingTimer||(this.userPollingTimer=setInterval((function(){t.isChatOpen&&t.checkDoctorReply()}),5e3))},stopUserPolling:function(){this.userPollingTimer&&(clearInterval(this.userPollingTimer),this.userPollingTimer=null)},startDoctorPolling:function(){var t=this;this.doctorPollingTimer||(this.doctorPollingTimer=setInterval((function(){t.checkNewMessages()}),5e3))},stopDoctorPolling:function(){this.doctorPollingTimer&&(clearInterval(this.doctorPollingTimer),this.doctorPollingTimer=null)},startDoctorChatPolling:function(){var t=this;if(!this.isDoctor||!this.chatPollingTimer){if(!this.currentPatient||!this.currentPatient.userId||!this.doctorInfo.id)return;this.chatPollingTimer=setInterval((function(){t.isChatOpen&&t.pollDoctorChatMessages()}),3e3)}},stopDoctorChatPolling:function(){this.chatPollingTimer&&(clearInterval(this.chatPollingTimer),this.chatPollingTimer=null,console.log("åŒ»ç”ŸèŠå¤©çª—å£è½®è¯¢å·²åœæ­¢"))},pollDoctorChatMessages:function(){var e=this;this.isDoctor&&this.currentPatient&&this.currentPatient.userId&&this.doctorInfo.id&&this.$api.list("message",{doctorId:this.doctorInfo.id,userId:this.currentPatient.userId}).then((function(o){if(o&&0===o.code&&Array.isArray(o.data)){var n=o.data.map((function(t){return{id:t.id,content:t.content,imageUrl:t.imageUrl,time:e.formatTime(new Date(t.sendTime)),ts:t.sendTime?new Date(t.sendTime).getTime():t.id||0,senderType:"doctor"===t.senderType?"doctor":"user"}})),i=new Set(e.chatMessages.map((function(t){return t.id}))),s=!1;n.forEach((function(t){i.has(t.id)||(e.chatMessages.push(t),s=!0)})),s&&(e.chatMessages.sort((function(t,e){return(t.ts||0)-(e.ts||0)})),e.scrollToBottom(),t.vibrateShort())}})).catch((function(t){console.error("è½®è¯¢åŒ»ç”ŸèŠå¤©æ¶ˆæ¯å¤±è´¥",t)}))},scrollToBottom:function(){var e=this;this.$nextTick((function(){var o=t.createSelectorQuery().in(e);o.select(".chat-messages").boundingClientRect(),o.selectViewport().scrollOffset(),o.exec((function(t){t&&t[0]?e.scrollTop=t[0].height:e.scrollTop=Number.MAX_SAFE_INTEGER}))}))},makeAppointment:function(t){this.currentDoctor=t,this.appointmentDate="",this.timeIndex=0,this.symptomDescription="",this.$refs.appointmentPopup.open()},closeAppointment:function(){this.$refs.appointmentPopup.close()},onDateChange:function(t){this.appointmentDate=t.detail.value},onTimeChange:function(t){this.timeIndex=t.detail.value},submitAppointment:function(){var e=this;if(this.appointmentDate)if(this.symptomDescription.trim()){t.showLoading({title:"æäº¤ä¸­..."});var o=t.getStorageSync("userid");if(!o)return t.hideLoading(),t.showToast({title:"è¯·å…ˆç™»å½•",icon:"none"}),void t.navigateTo({url:"/pages/login/login"});var n=t.getStorageSync("nowTable")||"defaultuser";this.$api.session(n).then((function(n){var i=n&&n.data||{},s=e.timeSlots[e.timeIndex]||"",r="".concat(e.appointmentDate," ").concat(s,":00"),a={yuyuebianhao:Date.now(),xiangmumingcheng:"".concat(e.currentDoctor.name||"","ï¼ˆåŒ»ç”Ÿé¢„çº¦ï¼‰"),fengmian:"",yuyueshijian:r,yuyueshizhang:"30åˆ†é’Ÿ",beizhu:e.symptomDescription.trim(),zhanghao:i.zhanghao||"",xingming:i.xingming||"",shouji:i.shouji||"",shangjiazhanghao:e.currentDoctor.account||"",dianpuming:e.currentDoctor.name||"",sfsh:"å¾…å®¡æ ¸",shhf:"",userid:o||i.id||""};e.$api.add("xiangmuyuyue",a).then((function(o){t.hideLoading(),o&&0===o.code?(t.showToast({title:"å® ç‰©é¢„çº¦æˆåŠŸï¼",icon:"success"}),e.closeAppointment()):t.showToast({title:o.msg||"é¢„çº¦å¤±è´¥",icon:"none"})})).catch((function(e){t.hideLoading(),t.showToast({title:"æäº¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•",icon:"none"})}))})).catch((function(e){t.hideLoading(),t.showToast({title:"è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥",icon:"none"})}))}else t.showToast({title:"è¯·æè¿°å® ç‰©ç—‡çŠ¶",icon:"none"});else t.showToast({title:"è¯·é€‰æ‹©é¢„çº¦æ—¥æœŸ",icon:"none"})},formatTime:function(t){var e=t.getHours().toString().padStart(2,"0"),o=t.getMinutes().toString().padStart(2,"0");return"".concat(e,":").concat(o)}}};e.default=c}).call(this,o("df3c")["default"])},a4ca:function(t,e,o){"use strict";var n=o("e1d0"),i=o.n(n);i.a},a654:function(t,e,o){"use strict";o.d(e,"b",(function(){return i})),o.d(e,"c",(function(){return s})),o.d(e,"a",(function(){return n}));var n={uniPopup:function(){return o.e("components/uni-popup/uni-popup").then(o.bind(null,"7bbb"))}},i=function(){var t=this.$createElement,e=(this._self._c,this.isDoctor?this.patientMessages.length:null);this.$mp.data=Object.assign({},{$root:{g0:e}})},s=[]},adb6:function(t,e,o){"use strict";(function(t,e){var n=o("47a9");o("35f8");n(o("3240"));var i=n(o("15fc"));t.__webpack_require_UNI_MP_PLUGIN__=o,e(i.default)}).call(this,o("3223")["default"],o("df3c")["createPage"])},e136:function(t,e,o){"use strict";o.r(e);var n=o("1c52"),i=o.n(n);for(var s in n)["default"].indexOf(s)<0&&function(t){o.d(e,t,(function(){return n[t]}))}(s);e["default"]=i.a},e1d0:function(t,e,o){}},[["adb6","common/runtime","common/vendor"]]]);